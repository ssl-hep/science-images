# based on https://github.com/dask/dask-docker/blob/master/base/Dockerfile
# but more permissive about image size due to read-only requirement in openshift
# FROM daskdev/dask:2.9.0
FROM continuumio/miniconda3:4.12.0

RUN apt-get update -y && apt-get install gnupg2 netcat jq -y

RUN conda install --yes \
    -c conda-forge \
    conda-build \
    xrootd==5.4.3 \
    && conda build purge-all && conda clean -ti

RUN apt update && \
    apt upgrade -y && \
    apt install -y sudo

RUN mkdir -p /etc/grid-security/
RUN export X509_CERT_DIR=/etc/grid-security/certificates/
RUN wget https://repo.opensciencegrid.org/cadist/1.126IGTFNEW/osg-certificates-1.126IGTFNEW.tar.gz
RUN tar -xvf osg-certificates-1.126IGTFNEW.tar.gz -C /etc/grid-security/

RUN useradd -ms /bin/bash output -G sudo && passwd -d output
RUN mkdir -p /etc/grid-security/certificates /etc/grid-security/vomsdir

ADD gai.conf /etc/gai.conf

COPY requirements.txt .
RUN /opt/conda/bin/pip install safety==1.9.0

RUN safety check -r requirements.txt -i 44715 -i44716 -i 44717
RUN /opt/conda/bin/pip install --no-cache-dir -r requirements.txt

WORKDIR /servicex
COPY proxy-exporter.sh .
RUN chmod +x proxy-exporter.sh

ENV PYTHONUNBUFFERED=1
ENV X509_USER_PROXY=/tmp/grid-security/x509up

RUN chgrp -R 0 /home/output && chmod -R g+rwX /home/output
